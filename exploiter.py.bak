# LogiScythe - exploiter.py
# Author: dangnosuy (Dang) & Gemini

import subprocess
import shlex
from typing import List, Dict, Any

class Exploiter:
    """
    The Exploiter takes the attack payloads (curl commands) suggested by the AI
    and executes them to test the potential vulnerabilities.
    """
    def __init__(self, cookies: List[Dict[str, Any]], target_domain: str):
        print("[Exploiter] Initialized Exploiter.")
        self.cookies = cookies
        self.target_domain = target_domain
        self.cookie_string = self._format_cookies()
        print(f"[Exploiter] Formatted cookie string for use: '{self.cookie_string}'")

    def _format_cookies(self) -> str:
        """Converts the cookie list from Playwright into a string for curl."""
        if not self.cookies:
            return ""
        return "; ".join([f"{cookie['name']}={cookie['value']}" for cookie in self.cookies])

    def _prepare_command(self, command_template: str) -> str:
        """Replaces placeholders in the command template with actual values."""
        
        # Replace domain placeholder
        command = command_template.replace("{target_domain}", self.target_domain)
        
        # Replace cookie placeholder
        # The AI might suggest different ways to include cookies, e.g., -b, --cookie
        # We will replace a generic placeholder for simplicity.
        command = command.replace("{session_cookie}", self.cookie_string)
        
        return command

    def run_attacks(self, attack_payloads: List[str]):
        """
        Executes a list of curl commands.
        """
        if not attack_payloads:
            print("[Exploiter] No attack payloads to execute.")
            return

        for i, payload_template in enumerate(attack_payloads):
            
            final_command = self._prepare_command(payload_template)
            
            print("\n" + "-"*10 + f" Executing Attack Payload #{i+1} " + "-"*10)
            print(f"[Exploiter] Command: {final_command}")
            
            try:
                # Use shlex.split to handle command line arguments safely
                args = shlex.split(final_command)
                
                # Execute the command
                # We add -i to include headers in the output
                if 'curl' in args and '-i' not in args:
                    args.insert(1, '-i')

                process = subprocess.run(
                    args,
                    capture_output=True,
                    text=True,
                    timeout=30 # 30-second timeout
                )
                
                print("[Exploiter] Execution complete. Results:")
                print("\n--- STDOUT ---")
                print(process.stdout if process.stdout else "(empty)")
                print("\n--- STDERR ---")
                print(process.stderr if process.stderr else "(empty)")
                print("--------------")

            except FileNotFoundError:
                print("[!] Error: 'curl' command not found. Please ensure curl is installed and in your PATH.")
                break
            except subprocess.TimeoutExpired:
                print("[!] Error: Command timed out after 30 seconds.")
            except Exception as e:
                print(f"[!] An unexpected error occurred while running the command: {e}")

# Example usage (for testing this file directly)
if __name__ == '__main__':
    print("[+] Running exploiter.py in standalone test mode.")
    
    # Dummy data similar to what would be passed from main.py
    dummy_cookies = [{'name': 'session', 'value': 'abc123xyz'}]
    dummy_domain = "httpbin.org" # Using httpbin.org for safe testing
    
    # Dummy payloads from the AI
    dummy_payloads = [
        "curl -X POST -b '{session_cookie}' -H 'Content-Type: application/json' -d '{\"price\": -100}' https://{target_domain}/post",
        "curl -X GET 'https://{target_domain}/get?user_id=123'"
    ]
    
    exploiter = Exploiter(cookies=dummy_cookies, target_domain=dummy_domain)
    exploiter.run_attacks(dummy_payloads)
